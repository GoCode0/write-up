import re

import pgpy
import six
from pgpy.constants import (CompressionAlgorithm, HashAlgorithm, KeyFlags,
                            PubKeyAlgorithm, SymmetricKeyAlgorithm)
from pgpy.packet.fields import RSAPriv
from pgpy.packet.types import MPI
from pgpy.types import Fingerprint


# patch key generation
def _generate(self, key_size):
    self.n = MPI(
        725401354775685765471207042678435149906987439481037372158628655910759100145297651090789090552819983280769410866946543213834489091253296834926018456794430566149326301276494461974965750778054929296933337180241258983775039348229462846424737415942479335077530179361603199139662991879642275847899732799150701967047117481576064288584386188945456995613909197306167601039258798940658104702377412083434310828607650235851550521627311238363877446524866781049426508294724662697469699897469644904315506283708020840430654789064178143082751238522604285614583182578536290776124127436090931001785593569443035399500093399270970177677006346805374398270228715193916202805713064067366827625424248908625973804821271498130516500890454769067221082631618406910592728779841917823920126692483859026027773533472180953330921846438281934377224852064910931118899593980828961294466350247259918597919642259730168318951551989939263913939343590055719985310531859126006565601022849064325005675137729407001708959286121905763349529864895154610112984601650756046534718728613480550455295197256458288978443776113223874993268938434543261453591413346379407608387768439983981579094001248563438000248047996370276317885816887923613940353742432145812687309985294725782482874674627
    )
    self.p = MPI(
        29744852921750395852177676680292066671820495687136888108096508893203491942637147343551799689693664653259007373433791037425728778224173365509791779887290809142920144819674870373275430712448703361905983597846797387762906666277941386571382908714150785660711576547307811219205893261700284215758415894351295659903386066244937658808351285466299672435006784349275884273945613760156358976112095492725658206988647501245026096378843639142062065676897125787995945129505916841144828713618912909772875408696949848904017362592191909912812317341827736766300875495158076255297697281290900829316341222138933663640294520594438741062839
    )
    self.q = MPI(
        24387458115324849955283813354471656178595096688278476566844787318407335967858060353197284716853650650072921789312630321425618966923772517448474438273767092012290328572064242224659341809941787338098736207279668314015590913311598325967584728107469142763585603819575477492823417129115799724096364868418469524569960203533345465396504010820567257832425885422095520612169948685363800252708609227360529814010483041249006591437536701837624639135166378449090272859569940743117993477496758112981550259270036633586302150066276982835880617666672299776556512680100555645878318203987426440692438648893136953524242064075838523505493
    )
    self.d = MPI(
        374549589457168173974703985797268215476792467836471361772370341751440822585970172807135084535710749870118499387011979123440884940704034539223057792689118145901201652637369670549016067878886747218806585544687488941391329424672120989062158619071327009470811049322021005778217739326109144031876330289614425498007345598044653241091399427006505016625403563294679424623761821526052910646257064673258367702660394530280309109378619482048236094312448952560104118500773423577821340232700235194121372921165078005086179217955395031566553537091511763140086978581184514756141787819245327283357839095417594257956324832353180033300431603312234015499998333828000122329752493427304185414216333068289510181663545156049075417037687784425839526744177474084644957700734078711418105750806556102118843727818820993462678328184687284474319118292549956898392675604948972136515871952555374653662098999657814702202957229553380931677566898357632215372166776272058666871126906802518311442203121462549970131427160453660253415215132265892985897576829430023211815843485864076604744125849914935393179401091948742864387414247850011941179682103999235828299186326071807128694308375763088724748156689972247790958302370911711534112645727746559978153842281989366249990698185
    )
    self.e = MPI(65537)
    self.u = MPI(
        9786273400697968928251196444552355005099488441989338536314940367122372167309875498568976850016698553511915562779768045497586979952095701492579896490592816759174701353549494432927134830733742850132615954771836616310660039910605496718766725095718066515669687590063850277517588408705880100723348625439909883851152909355579913905965906198410023744385717656009128576795837862881813772930093998124780752166922720777070278231147287801072750735781342087124977593230819153791565018609467518331172315376549255830204942245003861457862351154728005503340873563755638509239249420999924969347322667909746799157031489958072840559557
    )
    self._compute_chksum()


RSAPriv._generate = _generate


key = pgpy.PGPKey.new(PubKeyAlgorithm.RSAEncryptOrSign, 4096)

uid = pgpy.PGPUID.new(
    "epfl-ctf-admin2@protonmail.com", email="epfl-ctf-admin2@protonmail.com"
)

key.add_uid(
    uid,
    usage={
        KeyFlags.Certify,
        KeyFlags.Sign,
        KeyFlags.EncryptCommunications,
        KeyFlags.EncryptStorage,
    },
    hashes=[HashAlgorithm.SHA256, HashAlgorithm.SHA512, HashAlgorithm.SHA1],
    ciphers=[
        SymmetricKeyAlgorithm.AES256,
        SymmetricKeyAlgorithm.AES128,
        SymmetricKeyAlgorithm.AES192,
        SymmetricKeyAlgorithm.CAST5,
        SymmetricKeyAlgorithm.TripleDES,
    ],
    compression=[
        CompressionAlgorithm.ZLIB,
        CompressionAlgorithm.ZIP,
        CompressionAlgorithm.Uncompressed,
    ],
)

# patch fingerprint
FINGERPRINT_ENCODED = "2461 439C 55F8 627A"


def __new__(cls, content):
    if isinstance(content, Fingerprint):
        return content

    # validate input before continuing: this should be a string of 40 hex digits
    content = content.upper().replace(" ", "")
    if not bool(re.match(r"^[A-F0-9]{40}$", content)):
        raise ValueError("Expected: String of 40 hex digits")

    # store in the format: "AAAA BBBB CCCC DDDD EEEE  FFFF 0000 1111 2222 3333"
    #                                               ^^ note 2 spaces here
    spaces = [" " if i != 4 else "  " for i in range(10)]
    chunks = ["".join(g) for g in six.moves.zip_longest(*[iter(content)] * 4)]
    content = "".join(
        j for i in six.moves.zip_longest(chunks, spaces, fillvalue="") for j in i
    ).strip()

    content = content[:-19] + FINGERPRINT_ENCODED

    return str.__new__(cls, content)


Fingerprint.__new__ = __new__
msg_enc = pgpy.PGPMessage.from_file("msg.enc")

msg = key.decrypt(msg_enc)

flag = msg.message
print(flag)
